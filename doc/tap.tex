\documentclass{beamer}

\beamertemplatenavigationsymbolsempty
\setbeamerfont{page number in head/foot}{size=\small}
\setbeamertemplate{footline}[frame number]
\usefonttheme[onlymath]{serif}

\usepackage[utf8]{inputenc}

\usepackage[T1]{fontenc}
\usepackage[english]{babel}
%\usepackage[utf8]{inputenc}

\usepackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{arrows, backgrounds}
\usetikzlibrary{matrix, arrows.meta}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{positioning, fit, shapes}

\usepackage{ifthen}

%\usetikzlibrary{external}
%\tikzexternalize[prefix=tikz/]

\newcommand{\backupbegin}{
   \newcounter{finalframe}
   \setcounter{finalframe}{\value{framenumber}}
}
\newcommand{\backupend}{
   \setcounter{framenumber}{\value{finalframe}}
}

% Scale all pgf plots, not only coordinates
\usepackage{adjustbox}

%\usepackage{amsfonts}
%\usepackage{amsmath}
%\usepackage{amsthm}
\usepackage{bm}

\usepackage{pgfplots}
\pgfplotsset{compat=1.16}
\usepgfplotslibrary{groupplots}

% Used for split environment
\usepackage{amsmath}
% Separate rows in align environment by this amount
\addtolength{\jot}{1em}

\usepackage{graphicx}
\graphicspath{{../fig/} {fig/}}
\usepackage{subfig}
\usepackage{wrapfig}

% Clickable links
\usepackage{hyperref}
\hypersetup{
	colorlinks,
	citecolor=black,
	filecolor=black,
	linkcolor=black,
	urlcolor=black
}

\usepackage[pdf]{graphviz}

%\usepackage[dvipsnames]{xcolor}
\usepackage{listings}

\lstset{
	language=c,
  basicstyle=\small\ttfamily,  % the size of the fonts that are used for the code
	numbers=none,                   % where to put the line-numbers
  inputencoding=latin1,
  numberstyle=\tiny,  % the style that is used for the line-numbers
  stepnumber=1,                   % the step between two line-numbers. If it's
				    %1, each line 
                                  % will be numbered
  %numbersep=5pt,                  % how far the line-numbers are from the code
  backgroundcolor=\color{white},      % choose the background color.
  showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  showtabs=false,      % show tabs within strings adding particular underscores
	frame=none,                   % adds a frame around the code
  rulecolor=\color{black},        % if not set, the frame-color may be changed
				   % on line-breaks within not-black text (e.g.
				   % comments (green here))
	tabsize=6,                      % sets default tabsize to 2 spaces
  columns=fullflexible,
  extendedchars=true,
  captionpos=b,                   % sets the caption-position to bottom
  breaklines=true,                % sets automatic line breaking
  breakatwhitespace=false,        % sets if automatic breaks should only happen
				    %at whitespace
  title=\lstname,                   % show the filename of files included with
				    %\lstinputlisting;
                                  % also try caption instead of title
  keywordstyle=\color{blue},          % keyword style
	commentstyle=\color{gray},       % comment style
	stringstyle=\color{brown},         % string literal style
	escapeinside={|*}{*|},            % if you want to add LaTeX within your code
	morecomment=[l][\color{purple}]{\#},
	moredelim=[il][\color{purple}]{@},
	abovecaptionskip=-15pt
%	belowcaptionskip=-15pt
}


\usepackage{csquotes}

\usepackage{siunitx}

\usepackage{multicol}

\usepackage{epigraph}
\setlength{\epigraphwidth}{0.7\textwidth}

\usepackage{caption}
\captionsetup{font=footnotesize}

% Macros para ayudar a la redacciÃ³n
% Vector
\newcommand*\mat[1]{ \begin{pmatrix} #1 \end{pmatrix}}
\newcommand*\arr[1]{ \begin{bmatrix} #1 \end{bmatrix}}
\newcommand*\V[1]{\bm{#1}}
\newcommand{\E}{\V{E}}
\newcommand{\rhog}{\rho_\text{ghost}}
\newcommand{\F}{\V{F}}
\newcommand{\B}{\V{B}}
\renewcommand*{\v}{\V{v}}
\newcommand{\x}{\V{x}}
\newcommand{\dt}{\Delta t}
\newcommand{\dx}{\Delta x}
\newcommand*\neigh[1]{\mathcal{N}(#1)}

% Norm
\newcommand\norm[1]{\left\lVert#1\right\rVert}

\title{How TAP works\\{\small Example with the FFT in cpic.}}
\author{Rodrigo Arias Mallo}
\institute{Barcelona Supercomputing Center (BSC)}
\date{\today}








\tikzset{
	red-frame/.style={red}
}

% Running style for the nodes
\tikzset{
	running/.style={fill=green!30}
}

\tikzset{
	stopped/.style={fill=red!30}
}

% The threads are defined in a matrix called t, where each thread is labeled
% from t0 to t3, so we can reference them later.

\tikzset{
%	master/.pic = {
	pics/master/.style args={#1}{
		code={
			\matrix[
				ampersand replacement=\&,
				nodes={#1,draw,circle,inner sep=0mm,minimum size=8mm},
				column sep=5mm,
	%				left=1cm of O,
			] (t)
			{
				\node (t0) {$t_0$}; \&
				\node (t1) {$t_1$}; \&
				\node (t2) {$t_2$}; \&
				\node (t3) {$t_3$}; \\
			};

			\node[draw,fit=(t0) (t3),inner sep=1mm,rounded corners=4mm] (master) {};
			%\node[draw,fit=(t0) (t3),inner sep=0.5mm,ellipse] (master) {};

			\node[left=1mm of master] {Master process};
		}
	}
}

% Same for the workers, we have w for all of them, and w0 to w3 for each one.
\tikzset{
%	workers/.pic = {
	pics/workers/.style args={#1}{
		code={
			\matrix[
				ampersand replacement=\&,
				nodes={
					#1,
					double,
					double distance=1mm,
					draw,
					circle,
					inner sep=0mm,
					minimum size=8mm
				},
				column sep=5mm] (w) {
				\node (w0) {$w_0$}; \&
				\node (w1) {$w_1$}; \&
				\node (w2) {$w_2$}; \&
				\node (w3) {$w_3$}; \\
			};

			\node[right=1mm of w] {Workers};
		}
	}
}

% Same for CPUs, with c for all and c0 to c3 for each one.
\tikzset{
	pics/cpus/.style args={#1}{
		code={
		% Draw the CPUs
			\matrix[
				ampersand replacement=\&,
				matrix of nodes,
				nodes={
					draw,
					thick,
					rectangle,
					inner sep=0mm,
					minimum size=9mm
				},
				outer sep=0mm,
				inner sep=0mm,
				column sep=1mm
			] (n#1-c)
			{
				\node (n#1-c0) {$c_0$}; \&
				\node (n#1-c1) {$c_1$}; \&
				\node (n#1-c2) {$c_2$}; \&
				\node (n#1-c3) {$c_3$}; \\
			};
		}
	}
}

\tikzset{
	global/.style = {white}
}
\tikzset{
	shared/.style = {black}
}

\tikzset{
	pics/mem/.style args={#1/#2}{
		code={

			\matrix[
				nodes={
					anchor=center,
					draw,
					#2,
					rectangle,
					minimum width=4cm,
					minimum height=2em,
					outer sep=0mm,
					inner sep=0mm,
				},
				outer sep=0mm,
				inner sep=0mm,
				row sep =-\pgflinewidth,
				column sep = -\pgflinewidth,
				column sep=0mm,
			] (n#1-m)
			{
				\node (n#1-mp) {$\cdots$}; \\
				\node (n#1-m0) {$m_0$}; \\
				\node (n#1-m1) {$m_1$}; \\
				\node (n#1-m2) {$m_2$}; \\
				\node (n#1-m3) {$m_3$}; \\
				\node (n#1-mn) {$\cdots$}; \\
			};

			\ifthenelse{\equal{#2}{global}}{
				\node[below=-3mm of n#1-m.center] {Memory};
			}{}
		}
	}
}

% Same for CPUs, with c for all and c0 to c3 for each one.
\tikzset{
	%node/.pic = {
	pics/node/.style args={#1/#2}{
		code={

			\coordinate (n#1-O) at (0,0);


			% Draw the CPUs
			\pic[above=18mm of n#1-O] {cpus={#1}};

			% Draw the memory
			\pic [below=2mm of n#1-c] {mem={#1/#2}};

			%\draw (m.north west) rectangle (m.south east);
			\node[inner sep=0mm, draw,fit=(n#1-m)] {};
			\node (node#1) [
				inner sep=2mm,
				rounded corners=2mm,
				draw,
				fit=(n#1-c)(n#1-m)
			] {};
			\node[above=0mm of node#1] {Node #1};
		}
	}
}

\tikzset{
	canvas/.pic = {
		% Draw the canvas
		\draw[red-frame] (-10,-7.5) rectangle (10,7.5);
	}
}

\tikzset{
	pics/cluster/.style args={#1}{
		code={
			\pic[above=38mm of O] {node={1/#1}};
			\pic[below=38mm of O] {node={2/#1}};
		}
	}
}


\begin{document}

\frame{\titlepage}

\begin{frame}[fragile]
\begin{figure}[h]
\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
\begin{tikzpicture}[
		>=latex,
	]

	% The center will be the origin
	\coordinate (O) at (0,0);
	\pic {canvas};

	% Draw the CPUs
	\pic {cluster={global}};


	\node (text) [fill=gray!20,right=1cm of n1-c,text width=5cm]
		{Four CPUs are available at each node in this example.};

	\draw[->] (text) -- (n1-c3);

\end{tikzpicture}
\end{adjustbox}
\end{figure}
\end{frame}

\begin{frame}[fragile]
\begin{figure}[h]
\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
\begin{tikzpicture}[
		>=latex,
	]

	% The center will be the origin
	\coordinate (O) at (0,0);
	\pic {canvas};

	% Master process with 4 threads
	\pic[left=2cm of O] {master={running}};

	% Draw the CPUs
	\pic[above=4cm of O] {cpus};

	\node (text) [fill=gray!20,below=1cm of t,text width=5cm]
		{A master process is created with one thread for each CPU.};

\end{tikzpicture}
\end{adjustbox}
\end{figure}
\end{frame}

%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={running}};
%
%	\node (text) [fill=gray!20,below=1cm of w,text width=5cm]
%		{Additionally, a total of four worker processes are spawn from the master 
%		with \texttt{MPI\_Comm\_spawn(3)}.};
%
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={running}};
%
%	% Draw shared memory
%	%\pic[below=3cm of O] {mem};
%
%	\node[draw,
%				minimum width=4cm,
%				minimum height=4cm,
%				below=3cm of O,
%				] (m)	{};
%
%	\node (text) [fill=gray!20,below=1mm of m,text width=12cm]
%		{A shared memory between all processes is created from the master with 
%		\texttt{MPI\_Win\_allocate\_shared(3)}.};
%
%	% Draw lines from master to mem
%	\draw[dashed] (m.north) to[out=90,in=-90] (t.south);
%
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={running}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	\node (text) [fill=gray!20,left=1cm of m,text width=5cm]
%		{The memory is divided in slices and assigned to each worker as required by 
%		the FFT.};
%
%	% Draw shared memory lines
%	\foreach \i in {0,...,3}
%		\draw[dashed] (m\i) to[out=0,in=-90] (w\i);
%
%	% Draw lines from master to mem
%	\draw[dashed] (m.north) to[out=90,in=-90] (t.south);
%
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={stopped}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	\node (text) [fill=gray!20,above=0.5cm of w,text width=6cm]
%		{The workers are put to sleep, waiting a signal from the master.};
%
%	% Draw shared memory lines
%	\foreach \i in {0,...,3}
%		\draw[dashed] (m\i) to[out=0,in=-90] (w\i);
%
%	% Draw lines from master to mem
%	\draw[dashed] (m.north) to[out=90,in=-90] (t.south);
%
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={fill=green!30}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={stopped}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	\node (text) [fill=gray!20,below=0.5cm of t,text width=5cm]
%		{The simulation begins in the master process using all CPUs.};
%
%	% Draw arrows from threads to cpus
%	%\foreach \i in {0,...,3}
%	%	\draw[dashed] (t\i) -- (c\i);
%
%	\draw (t) -- (c);
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={stopped}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	% Draw lines from master to mem
%	\draw[->] (t.south) to[out=-90,in=90] (m.north);
%	%\draw[->] (t) -- (m);
%
%	\node (text) [fill=gray!20,left=1cm of m,text width=5cm]
%		{The field is updated in the shared memory from the master, and available to 
%		the workers.};
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={stopped}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={running}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	% Draw lines from master to the workers
%	\foreach \i in {0,...,3}
%		\draw[->] (t) to[out=20,in=180-45] (w\i);
%
%	\node (text) [fill=gray!20,below=1cm of O,text width=8cm]
%		{The master wakes all the workers and is put to sleep, waiting for them to 
%		finish.};
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={stopped}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={running}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	% Draw lines from the workers to mem
%	\foreach \i in {0,...,3}
%		\draw (w\i) to[out=-90,in=0] (m\i.east);
%
%	\foreach \i in {0,...,3}
%		\draw[dashed] (w\i) -- (c\i);
%
%	\node (text) [fill=gray!20,above=0.5cm of w,text width=6cm]
%		{The workers compute the FFT using all CPUs and store the results in the 
%		shared memory.};
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={stopped}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	% Draw lines from the workers to mem
%	\foreach \i in {0,...,3}
%		\draw[->] (w\i) to[out=180-45,in=45] (t.north);
%
%	\node (text) [fill=gray!20,below=1cm of O,text width=8cm]
%		{The workers wake the master in order to resume the simulation and are put 
%		to sleep.};
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}
%
%\begin{frame}[fragile]
%\begin{figure}[h]
%\begin{adjustbox}{max totalsize={\textwidth}{\textheight},center}
%\begin{tikzpicture}[
%		>=latex,
%	]
%
%	% The center will be the origin
%	\coordinate (O) at (0,0);
%
%	% Draw the canvas
%	\draw[red-frame] (-10,-8.5) rectangle (10,6);
%
%	% Master process with 4 threads
%	\pic[left=2cm of O] {master={running}};
%
%	% Draw the CPUs
%	\pic[above=4cm of O] {cpus};
%
%	% Draw the workers
%	\pic[right=2cm of O] {workers={stopped}};
%
%	% Draw shared memory
%	\pic[below=3cm of O] {mem};
%
%	\draw[<-] (t.south) to[out=-90,in=90] (m.north);
%
%	\node (text) [fill=gray!20,above=1cm of t,text width=8cm]
%		{The simulation is resumed using the result from the shared memory and 
%		continues until the next iteration, where the cycle is repeated.};
%
%\end{tikzpicture}
%\end{adjustbox}
%\end{figure}
%\end{frame}

\end{document}
